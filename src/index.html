<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
    <title>ProgramFighter</title>
    <style>
        body {
            padding: 12px;
        }
    </style>
    
    <script src="./js/enchant.min.js"></script>
    <script src="./js/physics.js"></script>
</head>
<body>
<table border="1" style="width: 100%"><tr><td>
<TextArea id="codeArea" style="width:320px; height:120px;">
function(step, pos, userData){
    return {
        "arrow": RIGHT,
        "jump": SHORT_JUMP,
        "shot": true
    };
}
</TextArea><br />
<button id="startButton">start</button>
<button id="slowStartButton">start(slow)</button>
<div style="width: 100%">パワーポイント: <span id="powerScoreText"></span></div>
<div style="width: 100%">時間ポイント: <span id="timeText"></span></div>
<div style="width: 100%">コードポイント: <span id="wordsText"></span></div>
<div style="width: 100%">合計ポイント: <span id="scoreText"></span></div>
<br>
<div style="width: 100%">経過フレーム: <span id="frameText"></span></div>
<div style="width: 100%">自分: <span id="heroPowerText"></span></div>
<div style="width: 100%">ボス: <span id="bossPowerText"></span></div>
</td><td>
<div id="enchant-stage" style="width:320px;height:320px"></div>
</td></tr>
</table>
■ルール<br>
目標は自機のプログラムを組んで敵に勝つこと。<br>
スコアが高いほど良い。<br>
良いスコアを出すポイントは、短時間で、受けたダメージが少なく、少ないコードで勝つこと<br>
<br>
■プログラムの仕様<br>
入力:<br>
step: int型。関数が呼ばれるたびにカウントアップする値。<br>
pos: 自機の位置。pox.x, pos.yからそれぞれの座標値が取れる。<br>
<br>
戻り値:<br>
{<br>
<table>
<tr><td>"arrow"</td><td>:RIGHT or LEFT or NONE</td></tr>
<tr><td>"jump"</td><td>: SHORT_JUMP or LONG_JUMP or NONE<br>または0から32までの数値。<br>参考値としてはSHORT_JUMPは16, LONG_JUMPは28</td></tr>
<tr><td>"shot"</td><td>: true or false</td></tr>
</table>
}<br>
<br>

<!-- 掲示板 -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'programfighter'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'programfighter'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>

<!-- 掲示板 -->  

<script>

(function() {
    var game;
    var code;
    var MAX_POWER = 20;
    var createCode = function(code) {
        return code.replace('return', 'data=');
    };
    
    var showStatus = function(score, hero, boss) {
        wordsText.innerHTML = score.wordCount;
        timeText.innerHTML = score.timeScore;
        scoreText.innerHTML = score.score;
        
        var text = "";
        for(var i = 0; i < hero.power; i++) {
            text += "■";
        }
        heroPowerText.innerHTML = text;
        
        text = "";
        for(var i = 0; i < boss.power; i++) {
            text += "■";
        }
        
        bossPowerText.innerHTML = text;
        frameText.innerHTML = hero.sprite.age;
    }
    
    var startGame = function(fps) {
        return function() {
            code = codeArea.value;
            var scene = new Scene();
            var hero = new Hero(game);
            var boss = new Boss(game);
            var shotLayer = new Group();
            var enemyShotLayer = new Group();
            game.fps = fps;
            game.enemies = [boss];
            game.shotLayer = shotLayer;
            game.enemyShotLayer = enemyShotLayer;
            
            scene.addChild(shotLayer);
            
            scene.addChild(boss.sprite);
            scene.addChild(enemyShotLayer);
            scene.addChild(hero.sprite);
            game.hero = hero;
            game.boss = boss;
            game.popScene();
            game.pushScene(scene);
            game.score.resetTime();
            game.score.setCode(code);
            game.resume();
        };
    };
    
    startButton.addEventListener("click", startGame(30));
    
    slowStartButton.addEventListener("click", startGame(10));
    
    window.onload = function () {
        enchant();
        enchant.ENV.PREVENT_DEFAULT_KEY_CODES = [];// keybindの解除
        game = new Game(320, 240);
        game.preload([Hero.IMG, Shot.IMG]);
        game.start();
        game.score = new Score();
        game.addEventListener('load', function() {
            // 開始
            startButton.click();
        });
        game.addEventListener('enterframe', function() {
            if(!game.hero || !game.boss) {
                
            }
            else if(game.hero.isDead) {
                scoreText.innerHTML = "0";
                heroPowerText.innerHTML = "LOSE...";
                game.pause();
            }
            else if(game.boss.isDead) {
                scoreText.innerHTML = game.score.score + " WIN!!";
                bossPowerText.innerHTML = "";
                game.pause();
            }
            else {
                game.score.enterframe(game.hero.power);
                wordsText.innerHTML = game.score.wordCount;
                timeText.innerHTML = game.score.timeScore;
                scoreText.innerHTML = game.score.score;
                
                var text = "";
                for(var i = 0; i < game.hero.power; i++) {
                    text += "■";
                }
                heroPowerText.innerHTML = text;
                
                text = "";
                for(var i = 0; i < game.boss.power; i++) {
                    text += "■";
                }
                
                bossPowerText.innerHTML = text;
                frameText.innerHTML = game.hero.sprite.age;
            }
            
        });
    };
    
    var Hero = (function () {
        function Hero(game) {
            this.power = MAX_POWER;
            this.lastShotAge = 0;
            this.isHitting = false;
            this.hitStartAge = 0;
            this.orientation = 1;
            this.isDead = false;
            this.userData = {};
            var sprite = new Sprite(32, 32);
            this.sprite = sprite;
            sprite.step = 0;
            sprite.image = game.assets[Hero.IMG];
            sprite.physics = new Physics();
            var _this = this;
            sprite.addEventListener('enterframe', function() {
                if(_this.isDead) return;
                
                if(!_this.isHitting) {
                    _this.hitTest(game.enemies[0].sprite);
                    var isHit = false;
                    var hitSprite = null;
                    game.enemyShotLayer.childNodes.forEach(function(s) {
                        if(sprite.intersect(s)) {
                            isHit = true;
                            hitSprite = s;
                        }
                    });
                    if(isHit) {
                        _this.isHitting = true;
                        hitSprite.parentNode.removeChild(hitSprite);
                        _this.power -= 1;
                        if(_this.power <= 0) {
                            _this.isDead = true;
                        }
                        
                    }
                }
                
                try {
                    var heroPos = {"x":game.hero.sprite.x, "y":game.hero.sprite.y};
                    var data = program(code, sprite.step, heroPos, _this.userData);
                }catch(e) {
                    alert("hoge");
                    game.pause();
                    return;
                }
                if(data == -1) {
                    
                }
                var vx = 0;
                if(!_this.isHitting) {
                    if(data.arrow > 0) {
                        vx = Hero.VX;
                        _this.orientation = 1;
                    } else if(data.arrow < 0) {
                        vx = -Hero.VX;
                        _this.orientation = -1;
                    }
                    sprite.physics.v.x = vx;
                    sprite.frame = 0;
                    
                    if(data.shot && game.shotLayer.childNodes.length <= 3 && sprite.age - _this.lastShotAge > 4) {
                        _this.lastShotAge = sprite.age;
                        var shot = new Shot(game, sprite.x + sprite.width / 2, sprite.y + sprite.height / 2, _this.orientation);
                        game.shotLayer.addChild(shot.sprite);
                    }
                    
                    
                } else {
                    sprite.frame = 3;
                    if(sprite.age - _this.hitStartAge > 10) {
                        _this.isHitting = false;
                    }
                }
                
                sprite.physics.a = Physics.dim(0, 1.0 - sprite.physics.v.y * 0.1);
                
                sprite.physics.step();
                if(sprite.physics.p.y > game.height - sprite.height) {
                    sprite.physics.v.y = 0;
                    sprite.physics.p.y = game.height - sprite.height;
                }
                if(sprite.physics.p.x < 0) {
                    sprite.physics.p.x = 0;
                } else if(sprite.physics.p.x > game.width - sprite.width) {
                    sprite.physics.p.x = game.width - sprite.width;
                }
                
                if(sprite.physics.p.y == game.height - sprite.height && data.jump) {
                    // sprite.physics.v.y -= (data.jump == 1 ? Hero.SHORT_JUMP : Hero.LONG_JUMP);
                    sprite.physics.v.y -= Math.max(0, Math.min(data.jump, 32));
                }
                
                
                sprite.x = Math.floor(sprite.physics.p.x);
                sprite.y = Math.floor(sprite.physics.p.y);
                sprite.scaleX = _this.orientation;
                if(Math.abs(sprite.physics.v.x) > 0) {
                    sprite.frame = [0, 0, 1, 1, 0, 0, 2, 2][sprite.age % 8];
                } else {
                    sprite.frame = 0;
                }
                
                
                sprite.step++;
            });
        }
        
        Hero.prototype.hitTest = function(sprite) {
            if(!this.isHitting) {
                if(this.sprite.intersect(sprite)) {
                    this.isHitting = true;
                    this.hitStartAge = this.sprite.age;
                    this.sprite.physics.v.x = -3;
                    this.sprite.physics.v.y = -3;
                    this.power -= 1;
                    if(this.power <= 0) {
                        this.isDead = true;
                    }
                }
            }
        }
        
        Hero.IMG = 'img/images/chara1.png';
        Hero.VX = 2.0;
        Hero.LONG_JUMP = 28.0;
        Hero.SHORT_JUMP = 16.0;
        return Hero;
    })();
    
    var Boss = (function () {
        function Boss(game) {
            this.power = MAX_POWER;
            this.isDead = false;
            this.orientation = -1;
            this.lastShotAge = 0;
            
            var sprite = new Sprite(32, 32);
            this.sprite = sprite;
            sprite.step = 0;
            sprite.image = game.assets[Hero.IMG];
            sprite.frame = 5;
            sprite.scaleX = -1;
            sprite.x = 240;
            sprite.y = game.height - sprite.height;
            var _this = this;
            sprite.addEventListener('enterframe', function() {
                var isHit = false;
                var hitSprite = null;
                game.shotLayer.childNodes.forEach(function(s) {
                    if(sprite.intersect(s)) {
                        isHit = true;
                        hitSprite = s;
                    }
                });
                if(isHit) {
                    hitSprite.parentNode.removeChild(hitSprite);
                    _this.power -= 1;
                    if(_this.power <= 0) {
                        _this.isDead = true;
                    }
                }
                
                if(sprite.age % 3 == 0 && game.enemyShotLayer.childNodes.length < 4) {
                    _this.lastShotAge = sprite.age;
                    var shot = new Shot(game, sprite.x, sprite.y + sprite.height / 2, _this.orientation, true);
                    game.enemyShotLayer.addChild(shot.sprite);
                }
            });
        }
        return Boss;
    })();
    
    var Shot = (function () {
        function Shot(game, x, y, orientation, isEnemy) {
            var sprite = new Sprite(16, 16);
            this.sprite = sprite;
            sprite.image = game.assets[Shot.IMG];
            sprite.frame = isEnemy ? 45 : 46;
            sprite.x = x;
            sprite.y = y;
            sprite.addEventListener('enterframe', function() {
                if(sprite.x < 0 || sprite.x > game.width) {
                    sprite.parentNode.removeChild(sprite);
                }
                
                
                sprite.x += 6 * orientation;
            });
        }
        Shot.IMG = "img/images/icon0.png";
        return Shot;
    })();
    
    var Score = (function () {
        function Score() {
            this.startTime = -1;
            this.timeScore = 0;
            this.wordCount = 0;
            this.score = 0;
            this.power = MAX_POWER;
        }
        Score.prototype.resetTime = function() {
            this.startTime = new Date().getTime();
        };
        Score.prototype.setCode = function(code) {
            this.wordCount = countWords(code);
        };
        Score.prototype.enterframe = function(power) {
            if(this.startTime < 0) return;
            this.timeScore = Math.floor((30 - Math.floor((new Date().getTime() - this.startTime)/1000)) * 100 / 30);
            this.power = Math.floor(power * 99 / MAX_POWER);
            this.score = this.power * 100 + this.timeScore - this.wordCount;
            // this.score = Math.floor(this.timeScore + this.wordCount / this.power);
        };
        
        var replaceAll = function(expression, org, dest){  
            return expression.split(org).join(dest);  
        }
        var countWords = function(s){
            s = s.replace(/(^\s*)|(\s*$)/gi,"");
            s = s.replace(/[ ]{2,}/gi," ");
            s = s.replace(/\n /," ");
            var rep = '{}();:+-*/%&|<>?!"\'';
            for(var i = 0; i < rep.length; i++) {
                s = replaceAll(s, rep.charAt(i)," ");
            }
            s = replaceAll(s, "  "," ");
            return s.trim().split(' ').length;
        }
        return Score;
    })();
    
    
    
    // tab accept
    document.querySelector("textarea").addEventListener("keydown", function(e) {
        if (e.keyCode === 9) {//tab
            e.preventDefault();
            var elem = e.target;
            var val = elem.value;
            var pos = elem.selectionStart;
            elem.value = val.substr(0, pos) + '\t' + val.substr(pos, val.length);
            elem.setSelectionRange(pos + 1, pos + 1);
        }
        
    });

})();

var program = function(code, step, pos, userData) {
    var NONE = 0;
    var SHORT_JUMP = 16;
    var LONG_JUMP = 28;
    var LEFT = -1;
    var RIGHT = 1;
    eval('var func = ' + code + ';');
    return func(step, pos, userData);
};

</script>

</body>
</html>